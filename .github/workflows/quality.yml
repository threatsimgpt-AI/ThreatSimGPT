name: Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    
    - name: Run ruff linter
      run: ruff check threatsimgpt/ tests/
    
    - name: Check ruff formatting
      run: ruff format --check threatsimgpt/ tests/ || true

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        pip install -e ".[dev,test]" || pip install -e "." || true
    
    - name: Generate coverage report
      run: pytest tests/unit/ -v --cov=threatsimgpt --cov-report=xml --cov-report=term-missing || true
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  documentation:
    name: Documentation Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install documentation tools
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme myst-parser || true
    
    - name: Build documentation
      run: |
        if [ -d "docs" ] && [ -f "docs/conf.py" ]; then
          cd docs
          sphinx-build -b html . _build/html || echo "Documentation build skipped"
        else
          echo "No Sphinx documentation configured, skipping"
        fi